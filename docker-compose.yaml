services:

  postgres:
    image: debezium/example-postgres:2.7.3.Final
    container_name: postgres
    volumes:
      - ./postgres/data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    env_file:
      - .env.docker

  debezium:
    image: debezium/connect:3.0.0.Final
    container_name: debezium
    ports:
      - "8083:8083"
    env_file:
      - .env.docker

  kafka:
    image: confluentinc/cp-kafka:latest
    container_name: kafka
    ports:
      - "29092:29092"
      - "9092:9092"
    env_file:
      - .env.docker
    healthcheck:
      test: [ "CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9092" ]
      interval: 10s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio
    container_name: minio
    ports:
      - "9000:9000"
      - "9001:9001"
    env_file:
      - .env.docker
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  bucket-setup:
    image: minio/mc
    container_name: bucket-setup
    env_file:
      - .env.docker
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      sleep 5 &&
      mc alias set myminio http://minio:9000 $${MINIO_ROOT_USER} $${MINIO_ROOT_PASSWORD} &&
      
      mc mb myminio/bronze || true &&
      mc anonymous set public myminio/bronze &&
      echo 'Bucket bronze ready.' && 
      
      mc mb myminio/silver || true &&
      mc anonymous set public myminio/silver &&
      echo 'Bucket silver ready.'
      "

  polaris:
    image: apache/polaris:latest
    container_name: polaris
    ports:
      - "8181:8181"
      - "8182:8182"
      - "5005:5005"
    env_file:
      - .env.docker
    depends_on:
      minio:
        condition: service_healthy
      bucket-setup:
        condition: service_completed_successfully          
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8182/q/health"]
      interval: 2s
      timeout: 10s
      retries: 10
      start_period: 10s

  polaris-setup:
    image: alpine/curl:8.17.0
    depends_on:
      polaris:
        condition: service_healthy
    env_file:
      - .env.docker
    entrypoint: /bin/sh
    command:
      - -c
      - |
        set -e
        apk add --no-cache jq

        echo "Obtaining root access token..."
        TOKEN_RESPONSE=$$(curl --fail-with-body -s -S -X POST http://polaris:8181/api/catalog/v1/oauth/tokens \
          -H 'Content-Type: application/x-www-form-urlencoded' \
          -d "grant_type=client_credentials&client_id=$${CLIENT_ID}&client_secret=$${CLIENT_SECRET}&scope=PRINCIPAL_ROLE:ALL" 2>&1) || {
          echo "âŒ Failed to obtain access token"
          echo "$$TOKEN_RESPONSE" >&2
          exit 1
        }

        TOKEN=$$(echo $$TOKEN_RESPONSE | jq -r '.access_token')
        if [ -z "$$TOKEN" ] || [ "$$TOKEN" = "null" ]; then
          echo "âŒ Failed to parse access token from response"
          echo "$$TOKEN_RESPONSE"
          exit 1
        fi
        echo "âœ… Obtained access token"

        echo "Creating catalog '$$CATALOG_NAME' in realm $$REALM..."
        PAYLOAD='{
          "catalog": {
            "name": "'$$CATALOG_NAME'",
            "type": "INTERNAL",
            "readOnly": false,
            "properties": {
              "default-base-location": "s3://bronze"
            },
            "storageConfigInfo": {
              "storageType": "S3",
              "allowedLocations": ["s3://bronze"],
              "endpoint": "http://localhost:9000",
              "endpointInternal": "http://rustfs:9000",
              "pathStyleAccess": true
            }
          }
        }'

        RESPONSE=$$(curl --fail-with-body -s -S -X POST http://polaris:8181/api/management/v1/catalogs \
          -H "Authorization: Bearer $$TOKEN" \
          -H "Accept: application/json" \
          -H "Content-Type: application/json" \
          -H "Polaris-Realm: $$REALM" \
          -d "$$PAYLOAD" 2>&1) && echo -n "" || {
          echo "âŒ Failed to create catalog"
          echo "$$RESPONSE" >&2
          exit 1
        }
        echo "âœ… Catalog created"

        echo ""
        echo "Creating principal 'de_user'..."
        PRINCIPAL_RESPONSE=$$(curl --fail-with-body -s -X POST http://polaris:8181/api/management/v1/principals \
          -H "Authorization: Bearer $$TOKEN" \
          -H "Polaris-Realm: $$REALM" \
          -H "Content-Type: application/json" \
          -d '{"principal": {"name": "de_user", "properties": {}}}' 2>&1) || {
          echo "âŒ Failed to create principal"
          echo "$$PRINCIPAL_RESPONSE" >&2
          exit 1
        }

        USER_CLIENT_ID=$$(echo $$PRINCIPAL_RESPONSE | jq -r '.credentials.clientId')
        USER_CLIENT_SECRET=$$(echo $$PRINCIPAL_RESPONSE | jq -r '.credentials.clientSecret')
        if [ -z "$$USER_CLIENT_ID" ] || [ "$$USER_CLIENT_ID" = "null" ] || [ -z "$$USER_CLIENT_SECRET" ] || [ "$$USER_CLIENT_SECRET" = "null" ]; then
          echo "âŒ Failed to parse user credentials from response"
          echo "$$PRINCIPAL_RESPONSE"
          exit 1
        fi
        echo "âœ… Principal created with clientId: $$USER_CLIENT_ID"

        echo "Creating principal role 'de_user_role'..."
        RESPONSE=$$(curl --fail-with-body -s -S -X POST http://polaris:8181/api/management/v1/principal-roles \
          -H "Authorization: Bearer $$TOKEN" \
          -H "Polaris-Realm: $$REALM" \
          -H "Content-Type: application/json" \
          -d '{"principalRole": {"name": "de_user_role", "properties": {}}}' 2>&1) && echo -n "" || {
          echo "âŒ Failed to create principal role"
          echo "$$RESPONSE" >&2
          exit 1
        }
        echo "âœ… Principal role created"

        echo "Creating catalog role 'de_catalog_role'..."
        RESPONSE=$$(curl --fail-with-body -s -S -X POST http://polaris:8181/api/management/v1/catalogs/$$CATALOG_NAME/catalog-roles \
          -H "Authorization: Bearer $$TOKEN" \
          -H "Polaris-Realm: $$REALM" \
          -H "Content-Type: application/json" \
          -d '{"catalogRole": {"name": "de_catalog_role", "properties": {}}}' 2>&1) && echo -n "" || {
          echo "âŒ Failed to create catalog role"
          echo "$$RESPONSE" >&2
          exit 1
        }
        echo "âœ… Catalog role created"

        echo "Assigning principal role to principal..."
        RESPONSE=$$(curl --fail-with-body -s -S -X PUT http://polaris:8181/api/management/v1/principals/de_user/principal-roles \
          -H "Authorization: Bearer $$TOKEN" \
          -H "Polaris-Realm: $$REALM" \
          -H "Content-Type: application/json" \
          -d '{"principalRole": {"name": "de_user_role"}}' 2>&1) && echo -n "" || {
          echo "âŒ Failed to assign principal role"
          echo "$$RESPONSE" >&2
          exit 1
        }
        echo "âœ… Principal role assigned"

        echo "Assigning catalog role to principal role..."
        RESPONSE=$$(curl --fail-with-body -s -S -X PUT http://polaris:8181/api/management/v1/principal-roles/de_user_role/catalog-roles/$$CATALOG_NAME \
          -H "Authorization: Bearer $$TOKEN" \
          -H "Polaris-Realm: $$REALM" \
          -H "Content-Type: application/json" \
          -d '{"catalogRole": {"name": "de_catalog_role"}}' 2>&1) && echo -n "" || {
          echo "âŒ Failed to assign catalog role"
          echo "$$RESPONSE" >&2
          exit 1
        }
        echo "âœ… Catalog role assigned"

        echo "Granting CATALOG_MANAGE_CONTENT privilege..."
        RESPONSE=$$(curl --fail-with-body -s -S -X PUT http://polaris:8181/api/management/v1/catalogs/$$CATALOG_NAME/catalog-roles/de_catalog_role/grants \
          -H "Authorization: Bearer $$TOKEN" \
          -H "Polaris-Realm: $$REALM" \
          -H "Content-Type: application/json" \
          -d '{"type": "catalog", "privilege": "CATALOG_MANAGE_CONTENT"}' 2>&1) && echo -n "" || {
          echo "âŒ Failed to grant privileges"
          echo "$$RESPONSE" >&2
          exit 1
        }
        echo "âœ… Privileges granted"

        echo ""
        echo "=========================================="
        echo "ðŸŽ‰ Polaris Quickstart Setup Complete!"
        echo "=========================================="
        echo ""
        echo "Catalog: $$CATALOG_NAME"
        echo "  Storage: S3 (RustFS)"
        echo "  Location: s3://bronze"
        echo "  RustFS UI: http://localhost:9001"
        echo ""
        echo "Root credentials:"
        echo "  Client ID:     $$CLIENT_ID"
        echo "  Client Secret: $$CLIENT_SECRET"
        echo ""
        echo "User credentials:"
        echo "  Client ID:     $$USER_CLIENT_ID"
        echo "  Client Secret: $$USER_CLIENT_SECRET"
        echo ""
        echo "Polaris main APIs:"
        echo "  - Iceberg REST:   http://localhost:8181/api/catalog/v1"
        echo "  - Management:     http://localhost:8181/api/management/v1"
        echo "  - Generic Tables: http://localhost:8181/api/polaris/v1"
        echo ""
        echo "Polaris admin APIs:"
        echo "  - Health check:   http://localhost:8182/q/health"
        echo "  - Metrics:        http://localhost:8182/q/metrics"
        echo ""
        echo "To get started with Spark:"
        echo "  spark-sql \\"
        echo "    --packages org.apache.iceberg:iceberg-spark-runtime-3.5_2.12:1.10.1,org.apache.iceberg:iceberg-aws-bundle:1.10.1 \\"
        echo "    --conf spark.sql.extensions=org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions \\"
        echo "    --conf spark.sql.catalog.polaris=org.apache.iceberg.spark.SparkCatalog \\"
        echo "    --conf spark.sql.catalog.polaris.type=rest \\"
        echo "    --conf spark.sql.catalog.polaris.warehouse=$$CATALOG_NAME \\"
        echo "    --conf spark.sql.catalog.polaris.uri=http://localhost:8181/api/catalog \\"
        echo "    --conf spark.sql.catalog.polaris.credential=$$USER_CLIENT_ID:$$USER_CLIENT_SECRET \\"
        echo "    --conf spark.sql.catalog.polaris.scope=PRINCIPAL_ROLE:ALL \\"
        echo "    --conf spark.sql.catalog.polaris.s3.endpoint=http://localhost:9000 \\"
        echo "    --conf spark.sql.catalog.polaris.s3.path-style-access=true \\"
        echo "    --conf spark.sql.catalog.polaris.s3.access-key-id=polaris_root \\"
        echo "    --conf spark.sql.catalog.polaris.s3.secret-access-key=polaris_pass \\"
        echo "    --conf spark.sql.catalog.polaris.client.region=irrelevant \\"
        echo "    --conf spark.sql.defaultCatalog=polaris"
        echo ""
        echo "To get started with REST API:"
        echo "  # Get a token"
        echo "  export TOKEN=\$$(curl -s -X POST http://localhost:8181/api/catalog/v1/oauth/tokens \\"
        echo "    -d 'grant_type=client_credentials' \\"
        echo "    -d 'client_id=$$USER_CLIENT_ID' \\"
        echo "    -d 'client_secret=$$USER_CLIENT_SECRET' \\"
        echo "    -d 'scope=PRINCIPAL_ROLE:ALL' \\"
        echo "    | jq -r '.access_token')"
        echo ""
        echo "  # Create a namespace"
        echo "  curl -X POST http://localhost:8181/api/catalog/v1/$$CATALOG_NAME/namespaces \\"
        echo "    -H \"Authorization: Bearer \$$TOKEN\" \\"
        echo "    -H 'Content-Type: application/json' \\"
        echo "    -d '{\"namespace\": [\"my_namespace\"], \"properties\": {}}'"
        echo ""
        echo "  # List namespaces"
        echo "  curl -X GET http://localhost:8181/api/catalog/v1/$$CATALOG_NAME/namespaces \\"
        echo "    -H \"Authorization: Bearer \$$TOKEN\""
        echo ""
        echo "=========================================="
 
        touch /tmp/polaris-setup-done
        tail -f /dev/null
    healthcheck:
      interval: 1s
      timeout: 10s
      retries: 240
      test: ["CMD", "test", "-f", "/tmp/polaris-setup-done"]

  iceberg-rest:
    image: apache/iceberg-rest-fixture
    container_name: iceberg-rest
    ports:
      - 8183:8181
    env_file:
      - .env.docker
      
  cdc-sink:
    build: ./cdc-sink
    container_name: cdc-sink
    depends_on:
      - kafka
      - minio
    env_file:
      - .env.docker